<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Book Your Sound Healing Session</title>
<style>
  :root{
    --bg:#f6fbfb; --card:#fff; --ink:#1e2a2a; --muted:#5e6b6b; --accent:#008e8c; --accent-2:#6bd6c8;
    --warn:#c2410c; --ok:#0f766e; --ring:0 0 0 3px rgba(0,142,140,.18); --shadow:0 14px 36px rgba(0,0,0,.08);
    --radius:16px; --chip:#eef7f6; --chip-b:#d9eeeb; --error:#dc2626;
  }
  html,body{height:100%;}
  body{margin:0;background:#f8faf9;color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  header{
    background:var(--accent); color:#fff; padding:18px 20px; text-align:center; font-weight:700; font-size:clamp(18px,3vw,22px);
    box-shadow:0 6px 18px rgba(0,0,0,.06);
  }
  .wrap{max-width:680px;margin:24px auto 80px;padding:0 16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;margin:14px 0}
  .grid{display:grid;gap:12px}
  @media(min-width:760px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  label{font-weight:600;font-size:14px;display:block;margin-bottom:6px}
  h2{color:var(--accent);margin:8px 0 10px;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  input[type=text],input[type=email],input[type=tel]{width:100%;padding:12px;border:1px solid #d8e9e6;border-radius:12px;background:#fbfefd;font-size:14px;transition:.15s;box-sizing:border-box}
  input:focus{outline:none;box-shadow:var(--ring);border-color:var(--accent)}
  .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .chip{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:999px;background:var(--chip);border:2px solid var(--chip-b);cursor:pointer;transition:.15s}
  .chip:hover{background:#e0f2f1;border-color:var(--accent)}
  .chip input{accent-color:var(--accent)}
  .chip.selected{background:#e7f7f4;border-color:var(--accent)}
  .service-card{padding:18px;border:2px solid #d8e9e6;border-radius:12px;cursor:pointer;transition:.15s;background:#fbfefd}
  .service-card:hover{border-color:var(--accent);background:#f0f9f8}
  .service-card.selected{border-color:var(--accent);background:#e7f7f4;box-shadow:var(--ring)}
  .service-card .service-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .service-card .service-name{font-weight:700;font-size:16px;color:var(--accent)}
  .service-card .service-price{font-weight:700;font-size:18px;color:var(--ok)}
  .service-card .service-duration{font-size:13px;color:var(--muted);margin-bottom:6px}
  .service-card .service-desc{font-size:13px;color:var(--muted);line-height:1.5}
  .slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:12px}
  .slot{padding:12px;border:2px solid #d8e9e6;border-radius:12px;background:#fbfefd;cursor:pointer;text-align:center;transition:.15s;font-size:14px;font-weight:600}
  .slot:hover{border-color:var(--accent);background:#f0f9f8}
  .slot.selected{border-color:var(--accent);background:#e7f7f4;box-shadow:var(--ring)}
  .slot.unavailable{opacity:.4;cursor:not-allowed;background:#f5f5f5}
  .payment-option{padding:18px;border:2px solid #d8e9e6;border-radius:12px;cursor:pointer;transition:.15s;background:#fbfefd;display:flex;align-items:center;gap:12px}
  .payment-option:hover{border-color:var(--accent);background:#f0f9f8}
  .payment-option.selected{border-color:var(--accent);background:#e7f7f4;box-shadow:var(--ring)}
  .payment-icon{font-size:32px}
  .payment-info{flex:1}
  .payment-name{font-weight:700;font-size:16px;color:var(--accent);margin-bottom:4px}
  .payment-desc{font-size:13px;color:var(--muted)}
  button{padding:14px 20px;border-radius:12px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(0,142,140,.25);font-size:16px;width:100%}
  button:hover{background:#006d6b}
  button:disabled{opacity:.5;cursor:not-allowed}
  .summary{background:#e7f7f4;border-left:4px solid var(--accent);padding:16px;border-radius:8px;margin-top:16px}
  .summary-row{display:flex;justify-content:space-between;margin:8px 0;font-size:14px}
  .summary-row.total{font-weight:700;font-size:16px;padding-top:12px;border-top:2px solid #d4efea;margin-top:12px}
  .info-banner{background:#fff3cd;border-left:4px solid #ffc107;padding:14px;border-radius:8px;margin-bottom:16px;font-size:14px;line-height:1.6}
  .success-banner{background:#d4edda;border-left:4px solid #28a745;padding:14px;border-radius:8px;margin-bottom:16px;font-size:14px;line-height:1.6}
  .error-banner{background:#fee;border-left:4px solid var(--error);padding:16px;border-radius:8px;margin-top:16px;font-size:14px;line-height:1.6;color:var(--error)}
  .required{color:#e11d48}
  .step{display:none}
  .step.active{display:block}
  .progress-bar{background:#e0e0e0;height:8px;border-radius:999px;margin-bottom:24px;overflow:hidden}
  .progress-fill{background:var(--accent);height:100%;width:0;transition:width .3s}
  .info{display:inline-flex;justify-content:center;align-items:center;width:18px;height:18px;border-radius:999px;margin-left:6px;background:#e7f7f4;border:1px solid #cfe7e4;color:#0a6e6a;font-weight:800;font-size:12px;cursor:pointer;position:relative;user-select:none}
  .info .tooltip{display:none;position:absolute;top:22px;left:0;z-index:30;min-width:240px;max-width:320px;padding:10px 12px;background:#fff;border:1px solid #dbeeee;border-radius:12px;box-shadow:var(--shadow);color:#007e8c;font-weight:400;line-height:1.45}
  .info:hover .tooltip{display:block}
</style>
</head>
<body>
  <header>üìÖ Book Your Sound Healing Session</header>
  <div class="wrap">

    <!-- Progress bar -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Info banner -->
    <div class="info-banner">
      <strong>üé™ Market Session Booking</strong><br>
      Book your session today! Pay online with card or pay cash when you arrive. You'll receive SMS & email reminders.
    </div>

    <!-- STEP 1: Client Details -->
    <section class="card step active" id="step1">
      <h2>Step 1: Your Details</h2>
      <div class="grid">
        <div>
          <label>First Name <span class="required">*</span></label>
          <input type="text" id="firstName" placeholder="First name" required/>
        </div>
        <div>
          <label>Surname <span class="required">*</span></label>
          <input type="text" id="surname" placeholder="Surname" required/>
        </div>
        <div>
          <label>Mobile Phone <span class="required">*</span></label>
          <input type="tel" id="phone" placeholder="04XX XXX XXX" required/>
          <span class="muted">For session reminders via SMS</span>
        </div>
        <div>
          <label>Email <span class="required">*</span></label>
          <input type="email" id="email" placeholder="your@email.com" required/>
        </div>
      </div>
      <div style="margin-top:20px">
        <button onclick="nextStep(1)">Continue to Safety Screen ‚Üí</button>
      </div>
    </section>

    <!-- STEP 2: Safety Screen -->
    <section class="card step" id="step2">
      <h2>Step 2: Safety Screen</h2>
      <p class="muted">Please confirm you do not have any contraindications. This ensures your safety during the session.</p>

      <div class="chips" style="margin-top:16px">
        <label class="chip">
          <input type="checkbox" value="Pacemakers/Implants" onchange="checkSafety()">
          Pacemakers/Implants
          <span class="info" tabindex="0">‚ùï
            <span class="tooltip">Low‚Äëfrequency vibration can interact with pacemakers.</span>
          </span>
        </label>
        <label class="chip">
          <input type="checkbox" value="Deep Vein Thrombosis" onchange="checkSafety()">
          DVT
          <span class="info" tabindex="0">‚ùï
            <span class="tooltip">Vibration may risk clot mobilisation.</span>
          </span>
        </label>
        <label class="chip">
          <input type="checkbox" value="Bleeding Disorders" onchange="checkSafety()">
          Bleeding Disorders
        </label>
        <label class="chip">
          <input type="checkbox" value="Recent Surgery" onchange="checkSafety()">
          Recent Surgery
        </label>
        <label class="chip">
          <input type="checkbox" value="Severe Low Blood Pressure" onchange="checkSafety()">
          Low Blood Pressure
        </label>
        <label class="chip">
          <input type="checkbox" value="Seizure Disorders" onchange="checkSafety()">
          Seizures
        </label>
        <label class="chip">
          <input type="checkbox" value="Acute Inflammation" onchange="checkSafety()">
          Acute Inflammation
        </label>
        <label class="chip">
          <input type="checkbox" value="Pregnancy" onchange="checkSafety()">
          Pregnancy
        </label>
        <label class="chip">
          <input type="checkbox" value="Active Cancer" onchange="checkSafety()">
          Active Cancer Treatment
        </label>
      </div>

      <div style="margin-top:24px;padding:16px;background:#f0f9f8;border-radius:12px;border:2px solid var(--accent)">
        <label class="chip" style="background:#fff;border:2px solid var(--accent);font-weight:700">
          <input type="checkbox" id="noneApply" value="None" onchange="checkSafety()">
          ‚úì None of the above apply to me
        </label>
      </div>

      <div id="safetyError" class="error-banner" style="display:none">
        <strong>‚ö†Ô∏è Session Not Suitable</strong><br>
        Based on your responses, vibroacoustic therapy may not be suitable. Please consult your healthcare provider.
      </div>

      <div style="margin-top:20px;display:flex;gap:12px">
        <button style="background:#e9f6f4;color:#0a6e6a;flex:1" onclick="prevStep(2)">‚Üê Back</button>
        <button id="continueToService" disabled style="flex:2" onclick="nextStep(2)">Continue to Select Service ‚Üí</button>
      </div>
    </section>

    <!-- STEP 3: Select Service -->
    <section class="card step" id="step3">
      <h2>Step 3: Choose Your Session</h2>
      <p class="muted">Select the duration that suits your needs</p>

      <div id="servicesContainer" style="display:grid;gap:12px;margin-top:16px">
        <!-- Services loaded from database -->
        <div class="muted" style="text-align:center;padding:20px">Loading services...</div>
      </div>

      <div style="margin-top:20px;display:flex;gap:12px">
        <button style="background:#e9f6f4;color:#0a6e6a;flex:1" onclick="prevStep(3)">‚Üê Back</button>
        <button id="continueToTime" disabled style="flex:2" onclick="nextStep(3)">Continue to Select Time ‚Üí</button>
      </div>
    </section>

    <!-- STEP 4: Select Time Slot -->
    <section class="card step" id="step4">
      <h2>Step 4: Select Time</h2>
      <p class="muted">Choose your preferred time</p>

      <div class="slots" id="slotsContainer">
        <!-- Time slots dynamically populated -->
      </div>

      <div style="margin-top:20px;display:flex;gap:12px">
        <button style="background:#e9f6f4;color:#0a6e6a;flex:1" onclick="prevStep(4)">‚Üê Back</button>
        <button id="continueToPayment" disabled style="flex:2" onclick="nextStep(4)">Continue to Payment ‚Üí</button>
      </div>
    </section>

    <!-- STEP 5: Payment Method -->
    <section class="card step" id="step5">
      <h2>Step 5: Payment Method</h2>
      <p class="muted">How would you like to pay?</p>

      <div style="display:grid;gap:12px;margin-top:16px">
        <div class="payment-option" id="paymentStripe" onclick="selectPayment('stripe')">
          <div class="payment-icon">üí≥</div>
          <div class="payment-info">
            <div class="payment-name">Pay Now with Card</div>
            <div class="payment-desc">Secure online payment via Stripe ‚Ä¢ Instant confirmation</div>
          </div>
        </div>

        <div class="payment-option" id="paymentCash" onclick="selectPayment('cash')">
          <div class="payment-icon">üíµ</div>
          <div class="payment-info">
            <div class="payment-name">Pay Cash at Market</div>
            <div class="payment-desc">Reserve your spot ‚Ä¢ Pay when you arrive</div>
          </div>
        </div>
      </div>

      <div style="margin-top:20px;display:flex;gap:12px">
        <button style="background:#e9f6f4;color:#0a6e6a;flex:1" onclick="prevStep(5)">‚Üê Back</button>
        <button id="continueToSummary" disabled style="flex:2" onclick="nextStep(5)">Continue to Summary ‚Üí</button>
      </div>
    </section>

    <!-- STEP 6: Booking Summary & Confirmation -->
    <section class="card step" id="step6">
      <h2>Booking Summary</h2>

      <div class="summary">
        <div class="summary-row">
          <span>Name:</span>
          <span id="summaryName">--</span>
        </div>
        <div class="summary-row">
          <span>Contact:</span>
          <span id="summaryContact">--</span>
        </div>
        <div class="summary-row">
          <span>Service:</span>
          <span id="summaryService">--</span>
        </div>
        <div class="summary-row">
          <span>Time:</span>
          <span id="summaryTime">--</span>
        </div>
        <div class="summary-row">
          <span>Payment Method:</span>
          <span id="summaryPayment">--</span>
        </div>
        <div class="summary-row total">
          <span>Total:</span>
          <span id="summaryTotal">$0</span>
        </div>
      </div>

      <div id="cashNotice" class="info-banner" style="display:none;margin-top:16px">
        <strong>üíµ Cash Payment</strong><br>
        Your booking is reserved! Please bring exact cash payment when you arrive at the market.
      </div>

      <div style="margin-top:20px;display:flex;gap:12px">
        <button style="background:#e9f6f4;color:#0a6e6a;flex:1" onclick="prevStep(6)">‚Üê Back</button>
        <button id="confirmBooking" style="flex:2" onclick="confirmBooking()">
          <span id="confirmButtonText">Confirm Booking ‚Üí</span>
        </button>
      </div>
    </section>

    <!-- Success Message -->
    <section class="card" id="successSection" style="display:none">
      <div class="success-banner">
        <h2 style="color:#28a745;margin-top:0">‚úÖ Booking Confirmed!</h2>
        <p style="margin:12px 0">Your session has been booked successfully.</p>
      </div>

      <div class="summary" id="successSummary">
        <!-- Summary will be populated here -->
      </div>

      <div id="successInstructions" style="margin-top:16px;line-height:1.7">
        <!-- Instructions based on payment method -->
      </div>

      <button onclick="location.reload()" style="margin-top:20px">Book Another Session</button>
    </section>

  </div>

<script>
// State management
let currentStep = 1;
let formData = {
  firstName: '',
  surname: '',
  phone: '',
  email: '',
  contraindications: [],
  safetyScreenPassed: false,
  selectedService: null,
  selectedTimeSlot: null,
  paymentMethod: null
};

let services = [];
let timeSlots = [];

// Simulate API call - replace with actual Supabase query
async function loadServices() {
  // In production: fetch from Supabase
  // const { data, error } = await supabase.from('services').select('*').eq('is_active', true).order('display_order');

  // Mock data matching database schema
  services = [
    {
      id: '1',
      service_name: 'Express Session',
      description: 'Quick relaxation and stress relief - perfect for a market visit',
      duration_minutes: 15,
      price_cents: 2500,
      icon_emoji: '‚ö°'
    },
    {
      id: '2',
      service_name: 'Standard Session',
      description: 'Deep relaxation and pain management',
      duration_minutes: 20,
      price_cents: 3500,
      icon_emoji: 'üéµ'
    },
    {
      id: '3',
      service_name: 'Extended Session',
      description: 'Full therapeutic experience with comprehensive healing',
      duration_minutes: 30,
      price_cents: 5000,
      icon_emoji: 'üåü'
    }
  ];

  renderServices();
}

function renderServices() {
  const container = document.getElementById('servicesContainer');
  container.innerHTML = services.map(service => `
    <div class="service-card" onclick="selectService('${service.id}')">
      <div class="service-header">
        <div>
          <span style="font-size:24px;margin-right:8px">${service.icon_emoji}</span>
          <span class="service-name">${service.service_name}</span>
        </div>
        <div class="service-price">$${(service.price_cents / 100).toFixed(2)}</div>
      </div>
      <div class="service-duration">${service.duration_minutes} minutes</div>
      <div class="service-desc">${service.description}</div>
    </div>
  `).join('');
}

function selectService(serviceId) {
  formData.selectedService = services.find(s => s.id === serviceId);

  document.querySelectorAll('.service-card').forEach(card => {
    card.classList.remove('selected');
  });
  event.currentTarget.classList.add('selected');

  document.getElementById('continueToService').disabled = false;
}

function generateTimeSlots() {
  const now = new Date();
  const slots = [];

  for (let h = now.getHours(); h < 17; h++) {
    for (let m = 0; m < 60; m += 15) {
      if (h === now.getHours() && m <= now.getMinutes()) continue;
      const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
      slots.push({ time: timeStr, available: Math.random() > 0.2 });
    }
  }

  timeSlots = slots;
  renderTimeSlots();
}

function renderTimeSlots() {
  const container = document.getElementById('slotsContainer');
  container.innerHTML = timeSlots.map((slot, idx) => `
    <div class="slot ${slot.available ? '' : 'unavailable'}" onclick="selectTimeSlot('${slot.time}', ${slot.available})">
      ${slot.time}
    </div>
  `).join('');
}

function selectTimeSlot(time, available) {
  if (!available) return;

  formData.selectedTimeSlot = time;

  document.querySelectorAll('.slot').forEach(slot => {
    slot.classList.remove('selected');
  });
  event.currentTarget.classList.add('selected');

  document.getElementById('continueToTime').disabled = false;
}

function selectPayment(method) {
  formData.paymentMethod = method;

  document.querySelectorAll('.payment-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  document.getElementById(`payment${method.charAt(0).toUpperCase() + method.slice(1)}`).classList.add('selected');

  document.getElementById('continueToPayment').disabled = false;
}

function updateProgress() {
  const progress = (currentStep / 6) * 100;
  document.getElementById('progressFill').style.width = `${progress}%`;
}

function nextStep(step) {
  // Validation
  if (step === 1) {
    formData.firstName = document.getElementById('firstName').value.trim();
    formData.surname = document.getElementById('surname').value.trim();
    formData.phone = document.getElementById('phone').value.trim();
    formData.email = document.getElementById('email').value.trim();

    if (!formData.firstName || !formData.surname || !formData.phone || !formData.email) {
      alert('Please fill in all required fields');
      return;
    }
  }

  if (step === 2 && !formData.safetyScreenPassed) {
    alert('Please confirm the safety screen');
    return;
  }

  if (step === 3 && !formData.selectedService) {
    alert('Please select a service');
    return;
  }

  if (step === 4 && !formData.selectedTimeSlot) {
    alert('Please select a time slot');
    return;
  }

  if (step === 5 && !formData.paymentMethod) {
    alert('Please select a payment method');
    return;
  }

  // Special handling for step transitions
  if (step === 2) loadServices();
  if (step === 3) generateTimeSlots();
  if (step === 5) updateSummary();

  // Hide current, show next
  document.getElementById(`step${currentStep}`).classList.remove('active');
  currentStep++;
  document.getElementById(`step${currentStep}`).classList.add('active');
  updateProgress();
  window.scrollTo(0, 0);
}

function prevStep(step) {
  document.getElementById(`step${currentStep}`).classList.remove('active');
  currentStep--;
  document.getElementById(`step${currentStep}`).classList.add('active');
  updateProgress();
  window.scrollTo(0, 0);
}

function checkSafety() {
  const contraindications = Array.from(document.querySelectorAll('.chip input[type="checkbox"]:not(#noneApply)'))
    .filter(cb => cb.checked)
    .map(cb => cb.value);

  const noneApply = document.getElementById('noneApply').checked;

  if (contraindications.length > 0) {
    document.getElementById('noneApply').checked = false;
    document.getElementById('safetyError').style.display = 'block';
    document.getElementById('continueToService').disabled = true;
    formData.safetyScreenPassed = false;
    formData.contraindications = contraindications;
  } else if (noneApply) {
    document.getElementById('safetyError').style.display = 'none';
    document.getElementById('continueToService').disabled = false;
    formData.safetyScreenPassed = true;
    formData.contraindications = [];
  } else {
    document.getElementById('continueToService').disabled = true;
    formData.safetyScreenPassed = false;
  }
}

function updateSummary() {
  document.getElementById('summaryName').textContent = `${formData.firstName} ${formData.surname}`;
  document.getElementById('summaryContact').textContent = formData.phone;
  document.getElementById('summaryService').textContent = `${formData.selectedService.service_name} (${formData.selectedService.duration_minutes} min)`;
  document.getElementById('summaryTime').textContent = formData.selectedTimeSlot;
  document.getElementById('summaryPayment').textContent = formData.paymentMethod === 'stripe' ? 'Card Payment (Stripe)' : 'Cash at Market';
  document.getElementById('summaryTotal').textContent = `$${(formData.selectedService.price_cents / 100).toFixed(2)}`;

  // Show cash notice if cash payment
  document.getElementById('cashNotice').style.display = formData.paymentMethod === 'cash' ? 'block' : 'none';

  // Update button text
  document.getElementById('confirmButtonText').textContent =
    formData.paymentMethod === 'stripe' ? 'Proceed to Payment ‚Üí' : 'Reserve Booking ‚Üí';
}

async function confirmBooking() {
  const btn = document.getElementById('confirmBooking');
  btn.disabled = true;
  btn.textContent = 'Processing...';

  // In production: Save to Supabase bookings table
  console.log('Booking data:', formData);

  if (formData.paymentMethod === 'stripe') {
    // Redirect to Stripe payment
    alert('Redirecting to Stripe payment...');
    // window.location.href = '/api/create-stripe-session?bookingData=' + encodeURIComponent(JSON.stringify(formData));
  } else {
    // Cash payment - just reserve the booking
    setTimeout(() => {
      showSuccessMessage();
    }, 1000);
  }
}

function showSuccessMessage() {
  document.getElementById('step6').classList.remove('active');
  document.getElementById('successSection').style.display = 'block';

  const summary = `
    <div class="summary-row"><span>Name:</span><span>${formData.firstName} ${formData.surname}</span></div>
    <div class="summary-row"><span>Contact:</span><span>${formData.phone}</span></div>
    <div class="summary-row"><span>Service:</span><span>${formData.selectedService.service_name}</span></div>
    <div class="summary-row"><span>Time:</span><span>${formData.selectedTimeSlot}</span></div>
    <div class="summary-row"><span>Payment:</span><span>${formData.paymentMethod === 'stripe' ? 'Card (Paid)' : 'Cash (On arrival)'}</span></div>
    <div class="summary-row total"><span>Total:</span><span>$${(formData.selectedService.price_cents / 100).toFixed(2)}</span></div>
  `;

  document.getElementById('successSummary').innerHTML = summary;

  const instructions = formData.paymentMethod === 'cash'
    ? `<div class="info-banner">
        <strong>üì± What's Next?</strong><br>
        ‚Ä¢ You'll receive an SMS reminder 15 minutes before your session<br>
        ‚Ä¢ Please bring $${(formData.selectedService.price_cents / 100).toFixed(2)} cash when you arrive<br>
        ‚Ä¢ Look for the Sound Healing booth at the market<br>
        ‚Ä¢ Arrive 5 minutes early to check in
      </div>`
    : `<div class="success-banner">
        <strong>‚úÖ Payment Confirmed</strong><br>
        ‚Ä¢ You'll receive an SMS reminder 15 minutes before your session<br>
        ‚Ä¢ Check your email for booking confirmation<br>
        ‚Ä¢ Look for the Sound Healing booth at the market<br>
        ‚Ä¢ Arrive 5 minutes early to check in
      </div>`;

  document.getElementById('successInstructions').innerHTML = instructions;
  window.scrollTo(0, 0);
}

// Initialize
updateProgress();
</script>
</body>
</html>
